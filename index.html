<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ LEVIATHAM ] - Foro Anónimo</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script type="module" src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.js"></script>
    <script nomodule src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.min.js"></script>

    <style>
        /* Fuente monoespaciada para la estética hacker */
        body {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            background-color: #000;
            color: #0F0; /* Verde brillante */
            overflow-x: hidden;
        }

        /* Estilo para el canvas de fondo */
        #matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }

        /* Contenedor principal sobre el fondo */
        .main-container {
            position: relative;
            z-index: 10;
        }

        /* Estilo de "glitch" para el logo */
        @keyframes glitch {
            0%, 100% { text-shadow: -1px -1px 0 #F0F, 1px 1px 0 #0FF; opacity: 1; }
            25% { text-shadow: 1px 1px 0 #F0F, -1px -1px 0 #0FF; }
            50% { text-shadow: 1px -1px 0 #F0F, -1px 1px 0 #0FF; }
            75% { text-shadow: -1px 1px 0 #F0F, 1px -1px 0 #0FF; }
            90% { opacity: 0.8; }
        }

        .logo-ascii {
            font-size: 14px;
            line-height: 1.2;
            color: #0F0;
            text-shadow: 0 0 5px #0F0;
            white-space: pre;
            text-align: center;
            animation: glitch 1.5s infinite steps(1);
        }

        /* Estilos de UI "Hacker" */
        .hacker-box {
            border: 1px solid #0F0;
            background-color: rgba(0, 10, 0, 0.5); /* Fondo oscuro semi-transparente */
            box-shadow: 0 0 10px #0F0 inset;
            padding: 16px;
            border-radius: 0;
        }
        
        .hacker-input, .hacker-textarea {
            background-color: #010;
            border: 1px solid #0A0;
            color: #0F0;
            padding: 8px;
            width: 100%;
            border-radius: 0;
            outline: none;
            transition: all 0.3s;
        }
        .hacker-input:focus, .hacker-textarea:focus {
            box-shadow: 0 0 15px #0F0;
            border-color: #0F0;
        }

        .hacker-btn {
            background-color: transparent;
            border: 1px solid #0F0;
            color: #0F0;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 0;
        }
        .hacker-btn:hover {
            background-color: #0F0;
            color: #000;
            box-shadow: 0 0 15px #0F0;
        }

        /* Animación de "scrolling text" para los laterales */
        .scrolling-log {
            height: 100vh;
            overflow: hidden;
            color: #050; /* Verde oscuro */
            font-size: 12px;
        }
        .scrolling-log-content {
            animation: scroll-up 60s linear infinite;
        }
        @keyframes scroll-up {
            from { transform: translateY(0); }
            to { transform: translateY(-100%); }
        }

        /* Estilo de "scan line" */
        .scan-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #0F0;
            opacity: 0.3;
            animation: scan 4s linear infinite;
            z-index: 1000;
            pointer-events: none;
        }
        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }

        /* Modal de Reglas */
        #rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
        }

    </style>
</head>
<body>
    <!-- Fondo animado -->
    <canvas id="matrix-bg"></canvas>
    
    <!-- Efecto de línea de escaneo -->
    <div class="scan-line"></div>

    <!-- Modal de Reglas -->
    <div id="rules-modal" class="p-4">
        <div class="hacker-box max-w-lg w-full relative">
            <h2 class="text-xl text-red-500 mb-4">[ PROTOCOLO DEL FORO ]</h2>
            <ul class="list-disc list-inside space-y-2">
                <li>Regla 1: La anonimidad es absoluta. No compartas información personal.</li>
                <li>Regla 2: El conocimiento es para compartir, no para dañar.</li>
                <li>Regla 3: No dejes rastro. Sé consciente de tu huella digital.</li>
                <li>Regla 4: El respeto al "operador" es clave. Las ideas se debaten, no se atacan.</li>
                <li>Regla 5: [ Imdustrias Lazarus ] no se hace responsable del contenido.</li>
            </ul>
            <button id="close-rules-btn" class="hacker-btn absolute top-4 right-4 text-red-500 border-red-500">X</button>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="main-container min-h-screen p-4 md:p-8">
        
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
            
            <!-- Sidebar Izquierdo (Hacking) -->
            <aside class="hidden md:block md:col-span-3">
                <div class="scrolling-log">
                    <pre id="log-left" class="scrolling-log-content"></pre>
                </div>
            </aside>

            <!-- Contenido Central del Foro -->
            <main class="md:col-span-6">
                <header class="text-center mb-8">
                    <pre class="logo-ascii">
[ Iniciando Codificación ]

               .'.. /|
              / |  //
           _.'./.'./
          ( LEVIATHAM )
           \_`\_`\_/
             / / /
            | | |
             \_/
    
[ Status: Online ]

[ Imdustrias Lazarus ]

          [ KaliHunter32 ]
</pre>
                    <div class="flex justify-center gap-4 mt-4">
                        <span class="text-green-400">Tu ID: <span id="user-id-display">Conectando...</span></span>
                        <button id="show-rules-btn" class="text-red-500 hover:text-red-300">[ VER REGLAS ]</button>
                    </div>
                </header>

                <!-- Formulario de Nuevo Post -->
                <section id="new-post-form" class="hacker-box mb-8">
                    <h2 class="text-lg mb-2">[ INICIAR NUEVA TRANSMISIÓN ]</h2>
                    <textarea id="post-text" class="hacker-textarea" rows="4" placeholder="Escribe tu mensaje..."></textarea>
                    <button id="submit-post-btn" class="hacker-btn mt-2">ENVIAR</button>
                </section>

                <!-- Sección de Posts -->
                <section id="posts-section">
                    <h2 class="text-xl mb-4">[ TRANSMISIONES ACTIVAS ]</h2>
                    <div id="posts-container" class="space-y-6">
                        <!-- Los posts se cargarán aquí -->
                        <p>Cargando transmisiones...</p>
                    </div>
                </section>
            </main>
            
            <!-- Sidebar Derecho (Hacking) -->
            <aside class="hidden md:block md:col-span-3">
                <div class="scrolling-log">
                    <pre id="log-right" class="scrolling-log-content"></pre>
                </div>
            </aside>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            serverTimestamp, 
            doc, 
            updateDoc, 
            arrayUnion,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        // Usar las variables globales proporcionadas por el entorno
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                // Fallback con tu config si las variables no están (aunque en el entorno sí estarán)
                apiKey: "AIzaSyBZCPk8qp39BoQ99qLfoQlT6pabnqaqinY",
                authDomain: "foro-513fa.firebaseapp.com",
                projectId: "foro-513fa",
                storageBucket: "foro-513fa.firebasestorage.app",
                messagingSenderId: "18055166367",
                appId: "1:18055166367:web:f6c6c421dd385eab4165aa"
            };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'foro-513fa';
        setLogLevel('Debug'); // Para ver logs de Firestore

        // --- Inicialización de Firebase ---
        let app, auth, db, currentUserId, currentUserHandle;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("[SYSTEM] Firebase inicializado.");
        } catch (e) {
            console.error("[ERROR] Conexión fallida con Firebase: ", e);
            document.getElementById('posts-container').innerHTML = '<p class="text-red-500">[ ERROR DE CONEXIÓN AL NÚCLEO ]</p>';
        }

        // --- Autenticación Anónima ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario ya está logueado (anónimamente)
                currentUserId = user.uid;
                currentUserHandle = `Anónimo-${user.uid.substring(0, 6)}`;
                document.getElementById('user-id-display').textContent = currentUserHandle;
                console.log(`[AUTH] Conexión establecida. ID: ${currentUserHandle}`);
                // Cargar posts una vez que tenemos auth
                loadPosts();
            } else {
                // Loguear al usuario anónimamente
                signInAnonymously(auth).catch((error) => {
                    console.error("[ERROR] Fallo de autenticación anónima: ", error);
                });
            }
        });

        // --- Lógica del Foro ---
        const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
        const postsContainer = document.getElementById('posts-container');
        const postTextInput = document.getElementById('post-text');
        const submitPostBtn = document.getElementById('submit-post-btn');

        // Cargar y mostrar posts en tiempo real
        function loadPosts() {
            const q = query(postsCollectionRef); // Podríamos ordenar por 'timestamp' pero requiere índice
            
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    postsContainer.innerHTML = '<p>[ No hay transmisiones. Inicia una. ]</p>';
                    return;
                }

                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ ...doc.data(), id: doc.id });
                });

                // Ordenar en el cliente (más simple que configurar índices de Firestore)
                // Ordenamos descendente para ver los más nuevos primero
                posts.sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds);

                postsContainer.innerHTML = ''; // Limpiar contenedor
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    postsContainer.appendChild(postElement);
                });

            }, (error) => {
                console.error("[ERROR] Fallo al cargar posts: ", error);
                postsContainer.innerHTML = '<p class="text-red-500">[ FALLO EN LA RECEPCIÓN DE DATOS ]</p>';
            });
        }

        // Crear elemento HTML para un post
        function createPostElement(post) {
            const div = document.createElement('div');
            div.className = 'hacker-box post-entry';
            div.setAttribute('data-id', post.id);

            const time = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString() : 'Enviando...';

            // Renderizar respuestas
            let repliesHTML = '<div class="space-y-2 mt-4 pl-4 border-l-2 border-green-700">';
            if (post.replies && post.replies.length > 0) {
                // Ordenar respuestas por fecha
                post.replies.sort((a, b) => a.timestamp?.seconds - b.timestamp?.seconds);
                
                post.replies.forEach(reply => {
                    const replyTime = reply.timestamp ? new Date(reply.timestamp.seconds * 1000).toLocaleString() : '...';
                    repliesHTML += `
                        <div class="text-sm">
                            <p class="text-green-300">${reply.text}</p>
                            <span class="text-xs text-green-600">>> ${reply.author} @ ${replyTime}</span>
                        </div>
                    `;
                });
            }
            repliesHTML += '</div>';

            div.innerHTML = `
                <p class="text-lg">${post.text}</p>
                <div class="text-xs text-green-500 mt-2">
                    <span>ID: ${post.author}</span> | <span>${time}</span>
                </div>
                ${repliesHTML}
                <!-- Formulario de Respuesta -->
                <div class="mt-4 flex gap-2">
                    <input type="text" class="hacker-input reply-input text-sm" placeholder="Responder...">
                    <button class="hacker-btn reply-btn text-sm">RESPONDER</button>
                </div>
            `;

            // Añadir listener al botón de responder
            div.querySelector('.reply-btn').addEventListener('click', () => {
                const replyInput = div.querySelector('.reply-input');
                const replyText = replyInput.value.trim();
                if (replyText) {
                    submitReply(post.id, replyText);
                    replyInput.value = ''; // Limpiar input
                }
            });
            
            // Permitir enviar respuesta con "Enter"
            div.querySelector('.reply-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const replyText = e.target.value.trim();
                    if (replyText) {
                        submitReply(post.id, replyText);
                        e.target.value = '';
                    }
                }
            });

            return div;
        }

        // Enviar un nuevo post
        async function submitNewPost() {
            const text = postTextInput.value.trim();
            if (text && currentUserHandle) {
                try {
                    await addDoc(postsCollectionRef, {
                        text: text,
                        author: currentUserHandle,
                        timestamp: serverTimestamp(),
                        replies: []
                    });
                    postTextInput.value = ''; // Limpiar textarea
                    console.log("[SYSTEM] Nueva transmisión enviada.");
                } catch (e) {
                    console.error("[ERROR] Fallo al enviar post: ", e);
                }
            }
        }

        // Enviar una respuesta
        async function submitReply(postId, text) {
            if (!text || !currentUserHandle) return;

            const postDocRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            
            try {
                await updateDoc(postDocRef, {
                    replies: arrayUnion({
                        text: text,
                        author: currentUserHandle,
                        timestamp: new Date() // Usamos new Date() para arrayUnion, serverTimestamp es más complejo aquí
                    })
                });
                console.log("[SYSTEM] Respuesta enviada.");
            } catch (e) {
                console.error("[ERROR] Fallo al enviar respuesta: ", e);
            }
        }

        // Listeners de UI
        submitPostBtn.addEventListener('click', submitNewPost);

        // --- Efectos Visuales (Hacking) ---

        // 1. Fondo de "Matrix"
        const canvas = document.getElementById('matrix-bg');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
        const chars = katakana + latin;
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; // Fondo semi-transparente para el efecto "fade"
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#0F0'; // Color del texto
            ctx.font = `${fontSize}px monospace`;

            for (let i = 0; i < drops.length; i++) {
                const text = chars[Math.floor(Math.random() * chars.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                // Reset drop si sale de la pantalla, con un efecto aleatorio
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }
        setInterval(drawMatrix, 40);

        // 2. Texto de "log" en los laterales
        const logLeft = document.getElementById('log-left');
        const logRight = document.getElementById('log-right');
        const logMessages = [
            '[INFO] KERNEL_MODULE_LOADED: vfs_cache.ko',
            '[WARN] CPU_TEMP_HIGH: Core 0 @ 85C',
            '[INIT] Mounting /dev/sda1...',
            '[AUTH] User root login attempt from 192.168.1.102',
            '[NET] PACKET_DROPPED: (RST_FLAG) TTL=0',
            '[SYS] SYN_FLOOD detected. Engaging countermeasures.',
            '[SEC] Firewall rule #403 applied. Port 22 closed.',
            '[DATA] Compiling payload... 0x00f1... 0x01a3...',
            '[OK] Access granted to node: 8.8.8.8',
            '[ERR] STACK_OVERFLOW: 0xDEADBEEF',
            '[DEBUG] Shifting memory registers... done.'
        ];

        function generateLogLines(count) {
            let content = '';
            for (let i = 0; i < count; i++) {
                content += `${logMessages[Math.floor(Math.random() * logMessages.length)]}\n`;
            }
            return content;
        }
        // Generar contenido duplicado para el efecto de scroll infinito
        const logContent = generateLogLines(200);
        if (logLeft) logLeft.innerHTML = logContent + logContent;
        if (logRight) logRight.innerHTML = logContent + logContent;

        // 3. Modal de Reglas
        const rulesModal = document.getElementById('rules-modal');
        const showRulesBtn = document.getElementById('show-rules-btn');
        const closeRulesBtn = document.getElementById('close-rules-btn');
        
        showRulesBtn.addEventListener('click', () => {
            rulesModal.style.display = 'flex';
        });
        closeRulesBtn.addEventListener('click', () => {
            rulesModal.style.display = 'none';
        });

    </script>
</body>
</html>
